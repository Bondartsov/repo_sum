# Active Context: Repository Analyzer (Milestone M2 - Hybrid Search)

**–î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:** 4 —Å–µ–Ω—Ç—è–±—Ä—è 2025  
**–°—Ç–∞—Ç—É—Å:** MILESTONE M2 –í –†–ê–ó–†–ê–ë–û–¢–ö–ï üöß - –ì–ò–ë–†–ò–î–ù–´–ô –ü–û–ò–°–ö BM25/SPLADE  
**–í–µ—Ä—Å–∏—è:** 1.8.0-dev (M2)
**–í–µ—Ç–∫–∞:** feature/milestone-m2-hybrid-search

## üéØ –¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã

### üöß –ê–ö–¢–ò–í–ù–ê–Ø –†–ê–ó–†–ê–ë–û–¢–ö–ê: Milestone M2 - –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –ø–æ–∏—Å–∫

**repo_sum** –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ **Milestone M2**: –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –≥–∏–±—Ä–∏–¥–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞ —Å BM25/SPLADE sparse vectors –¥–ª—è –ø–æ–≤—ã—à–µ–Ω–∏—è –∫–∞—á–µ—Å—Ç–≤–∞ —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–æ–∏—Å–∫–∞ –ø–æ –∫–æ–¥—É.

### üìã –ü–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ M2

–î–µ—Ç–∞–ª—å–Ω—ã–π –ø–ª–∞–Ω –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Ñ–∞–π–ª–µ: **MILESTONE_M2_IMPLEMENTATION_PLAN.md** (–≤—Ä–µ–º–µ–Ω–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç)

**–ö–ª—é—á–µ–≤—ã–µ —Ü–µ–ª–∏ M2:**
- **–ì–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–∏—Å–∫** - –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ dense (—Å–µ–º–∞–Ω—Ç–∏–∫–∞) –∏ sparse (–ª–µ–∫—Å–∏–∫–∞) –≤–µ–∫—Ç–æ—Ä–æ–≤
- **–£–ª—É—á—à–µ–Ω–Ω—ã–π RRF** - –Ω–∞—Å—Ç–æ—è—â–∏–π Reciprocal Rank Fusion –¥–ª—è –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
- **–°–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–ª—è –∫–æ–¥–∞** - —Ç–æ–∫–µ–Ω–∏–∑–∞—Ü–∏—è camelCase/snake_case
- **–ü–æ–≤—ã—à–µ–Ω–∏–µ –∫–∞—á–µ—Å—Ç–≤–∞** - Precision@10 +15-20%, Recall@100 +25-30%

### ‚úÖ –ó–ê–í–ï–†–®–Å–ù–ù–ê–Ø –§–ê–ó–ê: –§–ê–ó–ê 1.1 - –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –±–∞–≥–∏ CPUQueryEngine

**–°—Ç–∞—Ç—É—Å**: ‚úÖ **–ü–û–õ–ù–û–°–¢–¨–Æ –ó–ê–í–ï–†–®–ï–ù–ê** (4 —Å–µ–Ω—Ç—è–±—Ä—è 2025)

**–í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**
- ‚úÖ **Bug #1**: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω `_check_vector_store()` - –∑–∞–º–µ–Ω—ë–Ω `is_connected()` –Ω–∞ `health_check()`
- ‚úÖ **Bug #2**: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω `_ensure_embeddings()` - –∑–∞–º–µ–Ω—ë–Ω `embedding_dim` –Ω–∞ `config.vector_store.vector_size`
- ‚úÖ **Unit —Ç–µ—Å—Ç—ã**: –°–æ–∑–¥–∞–Ω `tests/rag/test_query_engine_health.py` —Å 7 —Ç–µ—Å—Ç–∞–º–∏
- ‚úÖ **–í–∞–ª–∏–¥–∞—Ü–∏—è**: –ö–æ–º–∞–Ω–¥–∞ `rag status` —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ, MMR fallback —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Ä–∞–∑–º–µ—Ä–Ω–æ—Å—Ç—å—é (384)

### üîÑ –¢–µ–∫—É—â–∞—è —Ñ–∞–∑–∞: –§–ê–ó–ê 1.2 - –û—Å—Ç–∞–ª—å–Ω—ã–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –±–∞–≥–∏

**–ü—Ä–æ–≥—Ä–µ—Å—Å –§–∞–∑—ã 1.2:**
- ‚úÖ CPUQueryEngine –±–∞–≥–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã (–§–∞–∑–∞ 1.1)
- [x] –ò—Å–ø—Ä–∞–≤–∏—Ç—å SearchService `min_score=0.0` –ª–æ–≥–∏–∫—É (–≤—ã–ø–æ–ª–Ω–µ–Ω–æ 05.09.2025)
- [x] –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø–æ—Ä–æ–≥–∏ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏ (0.5 –≤–µ–∑–¥–µ) (–≤—ã–ø–æ–ª–Ω–µ–Ω–æ 05.09.2025)
- [x] –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω—Ç—Ä–∞–∫—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Ç–æ–∫–µ–Ω–æ–≤ (–≤—ã–ø–æ–ª–Ω–µ–Ω–æ 05.09.2025)
- [x] –ê–∫—Ç—É–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å README.md –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é (–≤—ã–ø–æ–ª–Ω–µ–Ω–æ 05.09.2025)

### üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ M2

```
[–ö–æ–¥] ‚Üí [Tokenizer] ‚Üí ‚îú‚îÄ[Dense Embedder (—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π)] ‚Üí Dense Vectors
                      ‚îî‚îÄ[Sparse Encoder (–Ω–æ–≤—ã–π)]        ‚Üí Sparse Vectors
                                                               ‚Üì
                                                    [Hybrid Search + RRF]
                                                               ‚Üì
                                                         [Final Results]
```

## üìä –ë–∞–∑–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–µ—Ä–µ–¥ M2 (M1.7)

### ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ M1.7:
- RAG Core System —Å dense embeddings (BAAI/bge-small-en-v1.5)
- Qdrant –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –∫–≤–∞–Ω—Ç–æ–≤–∞–Ω–∏–µ–º
- RRF + MMR –∞–ª–≥–æ—Ä–∏—Ç–º—ã (–Ω–æ RRF –≤ demo-—Ä–µ–∂–∏–º–µ)
- Web UI –∏ CLI –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
- 149 —Ç–µ—Å—Ç–æ–≤ –ø—Ä–æ—Ö–æ–¥—è—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ

### ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –±–∞–≥–∏ M2:
1. ‚úÖ **QueryEngine.health_check()** - –ò–°–ü–†–ê–í–õ–ï–ù–û: –∑–∞–º–µ–Ω—ë–Ω `is_connected()` –Ω–∞ `health_check()` API
2. ‚úÖ **QueryEngine._ensure_embeddings()** - –ò–°–ü–†–ê–í–õ–ï–ù–û: –∑–∞–º–µ–Ω—ë–Ω `embedding_dim` –Ω–∞ `config.vector_store.vector_size`

### üêõ –û—Å—Ç–∞–≤—à–∏–µ—Å—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –±–∞–≥–∏ –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
3. **SearchService** - –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ `min_score=0.0`
4. **Config** - –∫–æ–Ω—Ñ–ª–∏–∫—Ç score_threshold (0.7 vs 0.5)
5. **Token stats** - –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞ UI/OpenAIManager
6. **README.md** - —É—Å—Ç–∞—Ä–µ–≤—à–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

## üéØ –ú–µ—Ç—Ä–∏–∫–∏ —É—Å–ø–µ—Ö–∞ M2

### –ö–∞—á–µ—Å—Ç–≤–æ –ø–æ–∏—Å–∫–∞:
- **Precision@10**: +15-20% –¥–ª—è —Ç–æ—á–Ω—ã—Ö —Ç–µ—Ä–º–∏–Ω–æ–≤
- **Recall@100**: +25-30% –∑–∞ —Å—á–µ—Ç sparse matching
- **MRR**: +10-15%

### –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:
- **–õ–∞—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å**: <300ms p95 (–¥–æ–ø—É—Å—Ç–∏–º–æ–µ —É–≤–µ–ª–∏—á–µ–Ω–∏–µ —Å 200ms)
- **–ò–Ω–¥–µ–∫—Å–∞—Ü–∏—è**: >8 —Ñ–∞–π–ª–æ–≤/—Å–µ–∫
- **–ü–∞–º—è—Ç—å**: <700MB –¥–ª—è 1000 –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤

### –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å:
- **Backward compatibility**: –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞
- **–í—Å–µ —Ç–µ—Å—Ç—ã**: 149+ –ø—Ä–æ—Ö–æ–¥—è—Ç —É—Å–ø–µ—à–Ω–æ

## üìù –ö–ª—é—á–µ–≤—ã–µ –Ω–æ–≤—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã M2

### –ù–æ–≤—ã–µ —Ñ–∞–π–ª—ã:
- `rag/sparse_encoder.py` - BM25/SPLADE –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ
- `rag/sparse_store.py` - —Ö—Ä–∞–Ω–∏–ª–∏—â–µ sparse vectors
- `rag/hybrid_search.py` - –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä –≥–∏–±—Ä–∏–¥–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞
- `tests/rag/test_sparse_*.py` - –Ω–æ–≤—ã–µ —Ç–µ—Å—Ç—ã

### –ò–∑–º–µ–Ω—è–µ–º—ã–µ —Ñ–∞–π–ª—ã:
- `rag/query_engine.py` - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ RRF, –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ weighted fusion
- `rag/search_service.py` - –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è sparse –ø–æ–∏—Å–∫–∞
- `config.py` - –Ω–æ–≤—ã–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ –∫–ª–∞—Å—Å—ã
- `requirements.txt` - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

## üõ†Ô∏è –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –ù–æ–≤—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:
- **rank-bm25** >= 0.2.2 - –¥–ª—è BM25 –∞–ª–≥–æ—Ä–∏—Ç–º–∞
- **nltk** >= 3.8 - –¥–ª—è —Ç–æ–∫–µ–Ω–∏–∑–∞—Ü–∏–∏
- **transformers** >= 4.30.0 - –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –¥–ª—è SPLADE

### –û–±–Ω–æ–≤–ª—è–µ–º—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:
- **fastembed** >= 0.3.6 (–±—ã–ª–æ 0.3.0)
- **sentence-transformers** >= 5.1.0 (–±—ã–ª–æ 3.0.0)

## üìÖ Timeline M2

**–û–±—â–∞—è –æ—Ü–µ–Ω–∫–∞:** 18-20 —Ä–∞–±–æ—á–∏—Ö –¥–Ω–µ–π
**–ù–∞—á–∞–ª–æ:** 4 —Å–µ–Ω—Ç—è–±—Ä—è 2025
**–ü–ª–∞–Ω–∏—Ä—É–µ–º–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ:** –∫–æ–Ω–µ—Ü —Å–µ–Ω—Ç—è–±—Ä—è 2025

### –§–∞–∑—ã:
- ‚úÖ **–§–∞–∑–∞ 1.1** (–ó–ê–í–ï–†–®–ï–ù–ê): CPUQueryEngine –±–∞–≥–∏ - 1 –¥–µ–Ω—å (4.09.2025)
- üîÑ **–§–∞–∑–∞ 1.2** (–¢–ï–ö–£–©–ê–Ø): –û—Å—Ç–∞–ª—å–Ω—ã–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –±–∞–≥–∏ - 1 –¥–µ–Ω—å
- **–§–∞–∑–∞ 2-3**: Sparse –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã - 4 –¥–Ω—è
- **–§–∞–∑–∞ 4-5**: RRF –∏ –≥–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–∏—Å–∫ - 4 –¥–Ω—è
- **–§–∞–∑–∞ 6**: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è - 3 –¥–Ω—è
- **–§–∞–∑–∞ 7**: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ - 3 –¥–Ω—è
- **–§–∞–∑–∞ 8-10**: –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è, –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è, —Ñ–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è - 3 –¥–Ω—è

## üö® –ê–∫—Ç–∏–≤–Ω—ã–µ —Ä–∏—Å–∫–∏

### –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ:
- –£–≤–µ–ª–∏—á–µ–Ω–∏–µ –ª–∞—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏ –∏–∑-–∑–∞ –¥–≤–æ–π–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞
- –†–∞–∑–º–µ—Ä sparse –∏–Ω–¥–µ–∫—Å–∞ (30k+ dimensions)
- –°–ª–æ–∂–Ω–æ—Å—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –±–µ–∑ –ø–æ–ª–æ–º–∫–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ

### –ú–∏—Ç–∏–≥–∞—Ü–∏—è:
- –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–æ–∏—Å–∫–æ–≤
- CSR —Ñ–æ—Ä–º–∞—Ç –¥–ª—è sparse vectors
- Feature flags –¥–ª—è –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ–≥–æ –≤–Ω–µ–¥—Ä–µ–Ω–∏—è

## üí° –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏ (–§–∞–∑–∞ 0)

1. ‚úÖ –°–æ–∑–¥–∞—Ç—å feature branch
2. ‚úÖ –û–±–Ω–æ–≤–∏—Ç—å Memory Bank
3. üîÑ –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –æ–∫—Ä—É–∂–µ–Ω–∏–µ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
4. [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Qdrant –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å
5. [ ] –°–¥–µ–ª–∞—Ç—å backup –∫–æ–ª–ª–µ–∫—Ü–∏–∏

---

## üèÜ –ü—Ä–µ–¥—ã–¥—É—â–∏–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è

### ‚úÖ M1.7 - –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è (02.09.2025):
- –£–±—Ä–∞–Ω—ã –≤—Å–µ —Ç–æ–∫–µ–Ω –ª–∏–º–∏—Ç—ã OpenAI
- Standalone RAG –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è
- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã RAG
- –°—Ç–∞–±–∏–ª—å–Ω–∞—è CI/CD —Å–∏—Å—Ç–µ–º–∞

### ‚úÖ Pytest Test Categorization (—Ä–∞–Ω–µ–µ):
- 149 passed, 3 skipped
- –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∑–∞—Ü–∏—è unit/integration/functional
- –†–µ—à–µ–Ω–∞ –ø—Ä–æ–±–ª–µ–º–∞ SocketBlockedError

---

**–ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï**: Milestone M2 –∞–∫—Ç–∏–≤–Ω–æ —Ä–∞–∑—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è. ‚úÖ **–§–∞–∑–∞ 1.1 (CPUQueryEngine –±–∞–≥–∏) –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–≤–µ—Ä—à–µ–Ω–∞** - –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ RAG —Å–∏—Å—Ç–µ–º—ã —É—Å—Ç—Ä–∞–Ω–µ–Ω—ã. üîÑ **–§–∞–∑–∞ 1.2 –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ** - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –±–∞–≥–æ–≤. –í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤–µ–¥—É—Ç—Å—è –≤ –≤–µ—Ç–∫–µ `feature/milestone-m2-hybrid-search`.
