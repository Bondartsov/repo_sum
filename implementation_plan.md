# Implementation Plan

## Overview
Решение проблемы падающих тестов в GitHub CI из-за блокировки сетевых соединений pytest-socket при инициализации RAG эмбеддеров.

Основная проблема: CPUEmbedder пытается загрузить модели эмбеддингов с HuggingFace Hub во время инициализации, но pytest-socket блокирует все сетевые запросы в CI окружении. Решение заключается в создании mock архитектуры, которая автоматически заменяет реальные эмбеддеры фиктивными в offline режиме, сохраняя при этом полную функциональность тестов.

## Types
Создание новых типов данных для mock архитектуры.

**MockCPUEmbedder class:**
- Наследует интерфейс CPUEmbedder
- Генерирует детерминированные фиктивные эмбеддинги без сетевых запросов
- Поддерживает все методы оригинального класса (embed_texts, get_stats, reset_stats)
- Имитирует статистику производительности
- Включает детекцию pytest-socket режима

**EmbedderMode enum:**
- REAL: использовать настоящие эмбеддеры
- MOCK: использовать фиктивные эмбеддеры
- AUTO: автоматическая детекция на основе окружения

## Files
Модификация файлов тестовой инфраструктуры.

**Новые файлы:**
- `tests/mocks/mock_cpu_embedder.py` - основной MockCPUEmbedder класс
- `tests/mocks/__init__.py` - пакет для mock объектов

**Изменяемые файлы:**
- `tests/conftest.py` - добавить глобальный патчинг CPUEmbedder
- `tests/rag/conftest.py` - интеграция MockCPUEmbedder с существующими фикстурами
- `tests/test_cpu_query_engine.py` - использование mock фикстур
- `tests/test_simple_cpu_query_engine.py` - использование mock фикстур
- `tests/test_rag_imports.py` - использование mock фикстур
- `tests/rag/test_rag_integration.py` - использование mock фикстур
- `tests/rag/test_rag_e2e_cli.py` - исправление логики тестов ошибок

## Functions
Создание и модификация функций для поддержки mock архитектуры.

**Новые функции:**
- `MockCPUEmbedder.__init__(embedding_config, parallelism_config)` - инициализация mock эмбеддера
- `MockCPUEmbedder.embed_texts(texts, deadline_ms)` - генерация фиктивных эмбеддингов
- `MockCPUEmbedder.get_stats()` - возврат имитированной статистики
- `MockCPUEmbedder.reset_stats()` - сброс mock статистики
- `MockCPUEmbedder.warmup()` - имитация прогрева модели
- `is_socket_disabled()` - детекция режима pytest-socket
- `auto_patch_embedder()` - автоматический патчинг в зависимости от окружения

**Модифицируемые функции:**
- Все тестовые функции, создающие CPUEmbedder напрямую → использовать фикстуры
- Функции тестирования ошибок → проверять mock ошибки вместо реальных

## Classes
Создание и модификация классов для mock архитектуры.

**Новые классы:**
- `MockCPUEmbedder` - главный mock класс, реализующий интерфейс CPUEmbedder
- `MockEmbedderStats` - имитация статистики производительности  
- `EmbedderModeDetector` - класс для определения режима работы

**Модифицируемые классы:**
- Тестовые классы в проблемных файлах → добавить использование mock фикстур

## Dependencies
Изменения в зависимостях не требуются.

Все mock объекты используют только стандартную библиотеку Python и numpy, который уже присутствует в requirements.txt.

## Testing
Стратегия тестирования mock архитектуры.

**Новые тесты:**
- `tests/test_mock_embedder.py` - unit тесты MockCPUEmbedder
- Тесты детекции режима pytest-socket
- Тесты автоматического переключения между real/mock режимами

**Изменения в существующих тестах:**
- Все проблемные тесты получат mock фикстуры
- Тесты производительности будут работать с фиктивными данными в CI
- E2E тесты будут правильно обрабатывать mock ошибки

**Валидационная стратегия:**
- Локальное тестирование: `pytest tests/ -v`
- Проверка offline режима: `pytest tests/ --disable-socket --allow-unix-socket`
- GitHub CI: автоматическая проверка в составе PR

## Implementation Order
Последовательность реализации изменений.

1. **Создать MockCPUEmbedder класс** - базовая mock архитектура
2. **Добавить детекцию pytest-socket** - определение режима работы
3. **Создать автоматический патчинг** - глобальная замена в conftest.py
4. **Обновить проблемные тесты** - интеграция mock фикстур
5. **Исправить логику E2E тестов** - корректная обработка mock ошибок
6. **Создать unit тесты для mock** - валидация mock архитектуры
7. **Локальное тестирование** - проверка работы в offline режиме
8. **Проверка в GitHub CI** - финальная валидация в cloud окружении
