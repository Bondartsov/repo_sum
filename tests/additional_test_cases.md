# Дополнительные тест‑кейсы для проекта

Целевой файл: [tests/additional_test_cases.md](tests/additional_test_cases.md)

Оглавление
- [T-001](#t-001)
- [T-002](#t-002)
- [T-003](#t-003)
- [T-004](#t-004)
- [T-005](#t-005)
- [T-006](#t-006)
- [T-007](#t-007)
- [T-008](#t-008)
- [T-009](#t-009)
- [T-010](#t-010)
- [T-011](#t-011)
- [T-012](#t-012)
- [T-013](#t-013)
- [T-014](#t-014)
- [T-015](#t-015)
- [T-016](#t-016)
- [T-017](#t-017)
- [T-018](#t-018)
- [T-019](#t-019)
- [T-020](#t-020)

Примечание: все упоминания файлов даны как кликабельные ссылки (например, [main.py](main.py)).

---

<a id="t-001"></a>
### T-001 — CLI: неизвестная подкоманда

- ID: T-001
- Название: CLI: обработка неизвестной подкоманды
- Предусловия:
  - Репозиторий открыт локально.
  - Доступен Python 3.10+.
- Шаги:
  1. Выполнить в терминале команду запуска CLI: `python main.py do-nothing`.
  2. Наблюдать вывод и код выхода процесса.
- Ожидаемый результат:
  - Приложение из [main.py](main.py) завершает работу с ненулевым кодом выхода.
  - В выводе присутствует понятное сообщение об ошибке и краткая подсказка по доступным подкомандам/флагам (usage/help).
  - Отсутствует трассировка исключения, не предназначенная для пользователя.

---

<a id="t-002"></a>
### T-002 — CLI: взаимоисключающие флаги

- ID: T-002
- Название: CLI: ошибка при использовании взаимоисключающих флагов/режимов
- Предусловия:
  - Репозиторий открыт локально.
- Шаги:
  1. Запустить CLI с комбинацией двух взаимоисключающих флагов (например, одновременный запуск генерации отчёта и веб-сервера): `python main.py --generate-docs --run-web`.
  2. Наблюдать поведение.
- Ожидаемый результат:
  - Логика в [main.py](main.py) отклоняет конфликтующие флаги до выполнения основной логики.
  - Отображается понятное сообщение о конфликте аргументов и корректный код выхода.
  - В журнале/выводе есть подсказка, как правильно использовать команды.

---

<a id="t-003"></a>
### T-003 — Конфигурация: приоритет CLI над .env и значениями по умолчанию

- ID: T-003
- Название: Приоритет настройки: CLI > .env > значения по умолчанию
- Предусловия:
  - Файл [.env.example](.env.example) доступен.
  - Переменная среды для порта веб‑сервера (например, PORT) задана в локальном .env.
- Шаги:
  1. Установить в локальном .env порт A (например, 8000).
  2. Запустить `python run_web.py --port 9000`.
  3. Проверить, на каком порту фактически поднят сервер.
- Ожидаемый результат:
  - В соответствии с логикой [config.py](config.py) и запуском из [run_web.py](run_web.py) значение, переданное через CLI, имеет наивысший приоритет.
  - Сервер запускается на порту 9000, несмотря на значение из .env.
  - В логах/выводе фиксируется эффективная конфигурация.

---

<a id="t-004"></a>
### T-004 — Веб‑режим: занятый порт

- ID: T-004
- Название: Корректная обработка ситуации «порт уже занят»
- Предусловия:
  - Запущен любой процесс, занимающий порт 8080 на localhost.
- Шаги:
  1. Выполнить `python run_web.py --port 8080`.
  2. Наблюдать поведение сервера.
- Ожидаемый результат:
  - [run_web.py](run_web.py) корректно сообщает о недоступности порта.
  - Приложение завершается с ненулевым кодом выхода или предлагает указать другой порт.
  - Нет «подвисания» процесса.

---

<a id="t-005"></a>
### T-005 — Web UI: 404 для неизвестного маршрута

- ID: T-005
- Название: Web UI возвращает 404/ошибку для несуществующего пути
- Предусловия:
  - Запущен веб‑сервер: `python run_web.py` (порт не важен).
- Шаги:
  1. Открыть в браузере/через curl путь `http://localhost:<port>/this-route-does-not-exist`.
- Ожидаемый результат:
  - Маршрутизация из [web_ui.py](web_ui.py) отдаёт 404.
  - Тело ответа содержит понятное сообщение об ошибке (JSON или HTML), без стека исключений.

---

<a id="t-006"></a>
### T-006 — Конфигурация: отсутствует обязательная переменная

- ID: T-006
- Название: Явная ошибка при отсутствии обязательной переменной окружения (например, OPENAI_API_KEY)
- Предусловия:
  - В .env и переменных окружения отсутствует ключ API.
- Шаги:
  1. Запустить CLI‑функциональность, требующую интеграцию с API (анализ/генерация документации): `python main.py --generate-docs`.
- Ожидаемый результат:
  - [config.py](config.py) или логика инициализации в [openai_integration.py](openai_integration.py) выявляет отсутствие ключа.
  - Отдаётся явное и человеко‑читаемое сообщение об ошибке, процесс корректно завершается.

---

<a id="t-007"></a>
### T-007 — Конфигурация: некорректная типизация значения в .env

- ID: T-007
- Название: Защита от нечисловых значений для числовых параметров (например, CHUNK_OVERLAP)
- Предусловия:
  - В .env установить `CHUNK_OVERLAP=not_a_number`.
- Шаги:
  1. Запустить действие, использующее параметры разбиения: `python main.py --analyze`.
- Ожидаемый результат:
  - Валидация в [config.py](config.py) корректно обрабатывает неверный тип.
  - Используется значение по умолчанию или выдаётся понятная ошибка до выполнения [code_chunker.py](code_chunker.py).
  - Нет необработанного исключения при приведении типов.

---

<a id="t-008"></a>
### T-008 — Сканер: уважение .gitignore

- ID: T-008
- Название: Сканер файлов не включает игнорируемые пути из .gitignore
- Предусловия:
  - В корне репозитория прописать в .gitignore шаблон `ignored_dir/`.
  - Внутри `ignored_dir/` создать тестовый кодовый файл.
- Шаги:
  1. Запустить анализ кода: `python main.py --analyze`.
  2. Проверить, что файлы из `ignored_dir/` не попали в список обрабатываемых.
- Ожидаемый результат:
  - [file_scanner.py](file_scanner.py) исключает пути согласно .gitignore.
  - В отчёте/результатах нет ссылок на файлы из игнорируемой директории.

---

<a id="t-009"></a>
### T-009 — Сканер: скрытые/системные файлы

- ID: T-009
- Название: По умолчанию скрытые и системные файлы исключаются из сканирования
- Предусловия:
  - Создан скрытый файл `.hidden_test.py` и/или системный файл на Windows.
- Шаги:
  1. Запустить анализ: `python main.py --analyze`.
  2. Проверить список просканированных файлов.
- Ожидаемый результат:
  - [file_scanner.py](file_scanner.py) исключает скрытые/системные объекты по умолчанию (или имеет настройку для этого).
  - В результате отсутствуют такие файлы.

---

<a id="t-010"></a>
### T-010 — Сканер: циклические симлинки

- ID: T-010
- Название: Обнаружение и безопасная обработка циклов симлинков
- Предусловия:
  - Создать директории A и B, где A содержит симлинк на B, а B содержит симлинк на A (Windows: «разрешить разработчику» для создания symlink).
- Шаги:
  1. Запустить анализ: `python main.py --analyze`.
  2. Мониторить производительность и отсутствие бесконечной рекурсии.
- Ожидаемый результат:
  - [file_scanner.py](file_scanner.py) распознаёт и прерывает циклы.
  - Нет переполнения стека/памяти, анализ завершается корректно.

---

<a id="t-011"></a>
### T-011 — Сканер: бинарные файлы и не‑UTF‑8 кодировки

- ID: T-011
- Название: Корректная фильтрация бинарников и обработка UTF‑16/UTF‑8 BOM
- Предусловия:
  - В проект добавить бинарный файл `image.png` и файл исходников в UTF‑16.
- Шаги:
  1. Запустить анализ: `python main.py --analyze`.
  2. Проверить, как обрабатываются файл UTF‑16 и бинарник.
- Ожидаемый результат:
  - [file_scanner.py](file_scanner.py) пропускает бинарники.
  - Текстовые файлы с BOM/UTF‑16 корректно детектируются/перекодируются или исключаются предсказуемым образом (с сообщением).

---

<a id="t-012"></a>
### T-012 — Chunking: отсутствие дубликатов на оверлапе

- ID: T-012
- Название: При оверлапе чанков нет повторного учёта контента
- Предусловия:
  - Подготовлен тестовый файл с длиной, требующей нескольких чанков с overlap.
- Шаги:
  1. Запустить режим анализа: `python main.py --analyze`.
  2. Сравнить границы соседних чанков по результатам [code_chunker.py](code_chunker.py).
- Ожидаемый результат:
  - На стыке чанков нет задвоений текста в агрегированном результате.
  - Межчанковая логика корректна для последующей генерации отчётов.

---

<a id="t-013"></a>
### T-013 — Chunking: точность границ

- ID: T-013
- Название: Контент на границе чанков не теряется и не обрезается
- Предусловия:
  - Файл с длинной строкой, длина которой близка к ограничению размера чанка.
- Шаги:
  1. Запустить анализ: `python main.py --analyze`.
  2. Проверить конкатенацию чанков из [code_chunker.py](code_chunker.py) обратно в исходный текст.
- Ожидаемый результат:
  - Конкатенация чанков в исходном порядке даёт точную копию исходного текста (без потерь и перестановок).

---

<a id="t-014"></a>
### T-014 — Utils: нормализация путей (Windows/UNC/POSIX)

- ID: T-014
- Название: Единая нормализация путей независимо от платформы и формата
- Предусловия:
  - В проекте есть смешанные форматы путей: `C:\repo\file.py`, `\\server\share\repo\file.py`, `/home/user/repo/file.py`.
- Шаги:
  1. Выполнить операции, приводящие к нормализации путей (сканирование/отчёт): `python main.py --analyze`.
  2. Изучить итоговые пути в результатах и/или логах.
- Ожидаемый результат:
  - Логика из [utils.py](utils.py) обеспечивает предсказуемый формат (например, прямые слеши, отсутствие дублирующих сегментов).
  - Пути консистентны во всех частях пайплайна (сканирование → чанкинг → генерация отчёта).

---

<a id="t-015"></a>
### T-015 — Докогенерация: коллизии заголовков Markdown

- ID: T-015
- Название: Разрешение коллизий одинаковых заголовков в отчёте
- Предусловия:
  - В нескольких входных файлах есть идентичные заголовки первого/второго уровня.
- Шаги:
  1. Запустить генерацию документации/отчётов: `python main.py --generate-docs`.
  2. Проверить итоговый Markdown.
- Ожидаемый результат:
  - [doc_generator.py](doc_generator.py) генерирует устойчивые к коллизиям якоря/заголовки (например, с суффиксами).
  - Ссылки внутри отчёта работают корректно, без конфликтов якорей.

---

<a id="t-016"></a>
### T-016 — Докогенерация: длинные строки, таблицы, списки

- ID: T-016
- Название: Сохранность форматирования сложных Markdown‑конструкций
- Предусловия:
  - Подготовлен контент с длинными строками, таблицами и вложенными списками.
- Шаги:
  1. Запустить генерацию: `python main.py --generate-docs`.
  2. Изучить сформированный отчёт.
- Ожидаемый результат:
  - [doc_generator.py](doc_generator.py) сохраняет таблицы и списки без искажений (межтабличные разделители, отступы).
  - Длинные строки корректно переносятся/сохраняются без поломки Markdown.
  - При необходимости учтена логика промпта [prompts/code_analysis_prompt.md](prompts/code_analysis_prompt.md).

---

<a id="t-017"></a>
### T-017 — OpenAI: rate limit и повторные запросы

- ID: T-017
- Название: Корректная реакция на 429 Too Many Requests (повторы с бэкоффом)
- Предусловия:
  - Имеется валидный API‑ключ, сеть доступна.
- Шаги:
  1. Смоделировать/поймать ответ 429 при обращении к API (например, кратковременно «перегрузить» лимит).
  2. Наблюдать поведение повторов.
- Ожидаемый результат:
  - [openai_integration.py](openai_integration.py) выполняет ограниченное число повторов с экспоненциальной задержкой.
  - В случае неуспеха после лимита повторов фиксируется контролируемая ошибка с понятным описанием.

---

<a id="t-018"></a>
### T-018 — OpenAI: офлайн/нет соединения

- ID: T-018
- Название: Ошибка сети обрабатывается без «зависания»
- Предусловия:
  - Отключить интернет/блокировать домены OpenAI.
- Шаги:
  1. Запустить функцию анализа/генерации, требующую обращения к API: `python main.py --generate-docs`.
  2. Наблюдать таймауты/поведение.
- Ожидаемый результат:
  - [openai_integration.py](openai_integration.py) возвращает контролируемую сетевую ошибку/таймаут.
  - Нет бесконечных ожиданий; лог содержит понятное описание проблемы.

---

<a id="t-019"></a>
### T-019 — Парсеры: синтаксические ошибки и смешанный контент

- ID: T-019
- Название: Грациозная обработка проблемного исходного кода в парсерах
- Предусловия:
  - Подготовить:
    - Файл с намеренной синтаксической ошибкой для каждого поддерживаемого языка.
    - Файл со смешанным содержимым (например, фрагменты JS внутри TS или HTML‑вставки в Python‑строках).
- Шаги:
  1. Запустить анализ кода: `python main.py --analyze`.
  2. Проверить, как парсеры справляются с ошибочным/смешанным кодом.
- Ожидаемый результат:
  - Логика [parsers/base_parser.py](parsers/base_parser.py), [parsers/python_parser.py](parsers/python_parser.py), [parsers/javascript_parser.py](parsers/javascript_parser.py), [parsers/typescript_parser.py](parsers/typescript_parser.py), [parsers/csharp_parser.py](parsers/csharp_parser.py), [parsers/cpp_parser.py](parsers/cpp_parser.py) не падает.
  - Проблемные файлы либо пропускаются с предупреждением, либо частично извлекаются без краша пайплайна.

---

<a id="t-020"></a>
### T-020 — Скрипт проверок зависимостей: отсутствующие пакеты

- ID: T-020
- Название: Отчёт о недостающих зависимостях и код выхода
- Предусловия:
  - Во временной среде отсутствует один из пакетов из [requirements.txt](requirements.txt).
- Шаги:
  1. Запустить `python scripts/verify_requirements.py`.
  2. Наблюдать вывод и код выхода.
- Ожидаемый результат:
  - [scripts/verify_requirements.py](scripts/verify_requirements.py) отчётливо указывает отсутствующие пакеты и версии.
  - Возвращается ненулевой код выхода при обнаружении проблем; при полном соответствии — нулевой.

---

## Матрица соответствия «Тест‑кейс → Область/файл»

| ID | Область | Файлы |
|---|---|---|
| T-001 | CLI: неизвестные команды | [main.py](main.py) |
| T-002 | CLI: конфликт аргументов | [main.py](main.py) |
| T-003 | Конфигурация и приоритеты | [config.py](config.py), [run_web.py](run_web.py), [.env.example](.env.example), [settings.json](settings.json) |
| T-004 | Веб‑режим: порт занят | [run_web.py](run_web.py) |
| T-005 | Web UI: 404 | [web_ui.py](web_ui.py) |
| T-006 | Конфигурация: обязательные переменные | [config.py](config.py), [openai_integration.py](openai_integration.py), [.env.example](.env.example) |
| T-007 | Конфигурация: типы значений | [config.py](config.py), [code_chunker.py](code_chunker.py) |
| T-008 | Сканер: .gitignore | [file_scanner.py](file_scanner.py) |
| T-009 | Сканер: скрытые/системные | [file_scanner.py](file_scanner.py) |
| T-010 | Сканер: симлинк‑циклы | [file_scanner.py](file_scanner.py) |
| T-011 | Сканер: бинарники/кодировки | [file_scanner.py](file_scanner.py) |
| T-012 | Chunking: overlap | [code_chunker.py](code_chunker.py) |
| T-013 | Chunking: границы | [code_chunker.py](code_chunker.py) |
| T-014 | Utils: нормализация путей | [utils.py](utils.py) |
| T-015 | Докогенерация: коллизии заголовков | [doc_generator.py](doc_generator.py) |
| T-016 | Докогенерация: форматирование Markdown | [doc_generator.py](doc_generator.py), [prompts/code_analysis_prompt.md](prompts/code_analysis_prompt.md) |
| T-017 | OpenAI: rate limit/retry | [openai_integration.py](openai_integration.py) |
| T-018 | OpenAI: офлайн/таймаут | [openai_integration.py](openai_integration.py) |
| T-019 | Парсеры: ошибки/смешанный код | [parsers/base_parser.py](parsers/base_parser.py), [parsers/python_parser.py](parsers/python_parser.py), [parsers/javascript_parser.py](parsers/javascript_parser.py), [parsers/typescript_parser.py](parsers/typescript_parser.py), [parsers/csharp_parser.py](parsers/csharp_parser.py), [parsers/cpp_parser.py](parsers/cpp_parser.py) |
| T-020 | Verify requirements | [scripts/verify_requirements.py](scripts/verify_requirements.py), [requirements.txt](requirements.txt) |
